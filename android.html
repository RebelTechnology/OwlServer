<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>OpenWareLaboratory</title>

<!-- grep '^REGISTER_PATCH'  Libraries/OwlPatches/patches.cpp  |sed 's:REGISTER_PATCH.*"\([^"]*\)".*:<option>\1</option>:g' -->

  <!-- <script src="//code.jquery.com/jquery-latest.min.js"></script> -->
  <!-- Set up Web MIDI polyfill -->
  <!-- <script src="http://cwilso.github.com/WebMIDIAPIShim/WebMIDIAPI.js"></script> -->
  <script src="WebMIDIAPI.js"></script>
  <script src="midiclient.js"></script>
  <script src="OpenWareMidiControl.js"></script>
  <script>

function requestStatus(){
  sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 3); // request firmware version
  <!-- setTimeout(function() { sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 127) }, 3000); -->
}

<!-- var timer = setInterval(requestStatus, 6000); -->

function noteOn(note, velocity) {
  console.log("received noteOn "+note+"/"+velocity);
}

function noteOff(note) {
  console.log("received noteOff "+note);
}

function getStringFromSysex(data, startOffset, endOffset){
     data = data.subarray(startOffset, data.length-endOffset);
    return String.fromCharCode.apply(null, data);
}

function systemExclusive(data) {
  if(data.length > 3 && data[0] == 0xf0
     && data[1] == MIDI_SYSEX_MANUFACTURER
     && data[2] == MIDI_SYSEX_DEVICE){
    <!-- console.log("sysex: 0x"+data[3].toString(16)+" length: "+data.length); -->
    switch(data[3]){
      case OpenWareMidiSysexCommand.SYSEX_PRESET_NAME_COMMAND:
        var index = data[4];
        var name = getStringFromSysex(data, 5, 2);
        setPreset(index, name);
        break;
      case OpenWareMidiSysexCommand.SYSEX_PARAMETER_NAME_COMMAND:
        var index = data[4];
        var name = getStringFromSysex(data, 5, 2);
        setParameter(index, name);
      break;
      case OpenWareMidiSysexCommand.SYSEX_FIRMWARE_VERSION:
        var name = getStringFromSysex(data, 4, 2);
        document.getElementById("firmwareVersion").innerHTML = name;
      break;
      case OpenWareMidiSysexCommand.SYSEX_DEVICE_ID:
      break;
      case OpenWareMidiSysexCommand.SYSEX_SELFTEST:
      break;
    }
  }
}

function registerMidiOutput(index, name){
  var select = document.getElementById("midiOutputs");
  select.options[index] = new Option(name, index);
}

function connect(){
  <!-- sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 3); // load firmware version (chrashes Chrome Android) -->
  sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 1); // load patch names
  sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 127); // load settings
}

function setPreset(index, name) {
  <!-- console.log("Preset "+index+": "+name); -->
  var select = document.getElementById("greenSlot");
  select.options[index] = new Option(name, index);
  select = document.getElementById("redSlot");
  select.options[index] = new Option(name, index);
}

function setParameter(index, name) {
  <!-- console.log("Parameter "+index+": "+name); -->
  var input;
  switch(index){
      case 0:
        input = document.getElementById("nameParameterA");
      break;
      case 1:
        input = document.getElementById("nameParameterB");
      break;
      case 2:
        input = document.getElementById("nameParameterC");
      break;
      case 3:
        input = document.getElementById("nameParameterD");
      break;
      case 4:
        input = document.getElementById("nameParameterE");
      break;
  }
  input.innerHTML = name;
}

function changePatch(cc, index){
  sendCc(cc, index);
  <!-- sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 2); // request parameter names (doesn't work, sometimes crashes) -->
  <!-- sendCc(OpenWareMidiControl.REQUEST_SETTINGS, OpenWareMidiControl.LED); -->
}

function changeMidiOutput(index){
  selectMidiOutput(index);
  <!-- sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 1); // load patch names -->
  <!-- setTimeout(function() { sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 1) }, 500); // load patch names -->
  <!-- setTimeout(function() { sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 127) }, 1000); // load settings   -->
}

function pressPushbutton(){
  sendCc(25, 127);
  sendCc(OpenWareMidiControl.REQUEST_SETTINGS, OpenWareMidiControl.LED);
}

function controlChange(cc, value) {
    <!-- console.log("received CC "+cc+": "+value); -->
    switch(cc){
    case OpenWareMidiControl.LED:
	var button = document.getElementById("pushbutton");
	if(value < 42){
	    button.style.backgroundColor = "white";
	}else if(value < 84){
	    button.style.backgroundColor = "lightgreen";
	}else{
	    button.style.backgroundColor = "red";
	}
	break;
    case OpenWareMidiControl.PATCH_PARAMETER_A:
	document.getElementById("parameterA").value = value;
	break;
    case OpenWareMidiControl.PATCH_PARAMETER_B:
	document.getElementById("parameterB").value = value;
	break;
    case OpenWareMidiControl.PATCH_PARAMETER_C:
	document.getElementById("parameterC").value = value;
	break;
    case OpenWareMidiControl.PATCH_PARAMETER_D:
	document.getElementById("parameterD").value = value;
	break;
    case OpenWareMidiControl.PATCH_PARAMETER_E:
	document.getElementById("parameterE").value = value;
	break;
    case OpenWareMidiControl.PATCH_CONTROL:
        var input = document.getElementById("patchControl");
	if(value == 127)
	  input.checked = true;
	else
	  input.checked = false;
	break;
    case OpenWareMidiControl.PATCH_MODE:
        var select = document.getElementById("patchMode");
        if(value < 32)
            select.selectedIndex = 0;
	else if(value < 64)
            select.selectedIndex = 1;
	else if(value < 96)
            select.selectedIndex = 2;
	else
            select.selectedIndex = 3;
	break;
    case OpenWareMidiControl.PATCH_SLOT_GREEN:
	document.getElementById("greenSlot").selectedIndex = value;
	break;
    case OpenWareMidiControl.PATCH_SLOT_RED:
	document.getElementById("redSlot").selectedIndex = value;
	break;
    }
}
  </script>
</head>
<body>

  <h2><span id="firmwareVersion">OpenWareLaboratory</span></h2>

  <p>MIDI 
  <select id="midiOutputs" onChange="changeMidiOutput(this.selectedIndex)">
    <option>...</option>
  </select>
  <button onClick="connect()">Connect</button>  
  </p>

  <p>Green Patch:
  <select id="greenSlot" onChange="changePatch(28, this.selectedIndex)">
    <option>...</option>
  </select>
  </p>

  <p>Red Patch:
    <select id="redSlot" onChange="changePatch(29, this.selectedIndex)">
      <!-- <select onChange="sendCc(29, this.options[this.selectedIndex].value)"> -->
      <option>...</option>
    </select>
  </p>

  <p>Patch Mode:
    <select id="patchMode" onChange="sendCc(27, this.options[this.selectedIndex].value)">
      <option value="0">Single</option>
      <option value="32">Dual</option>
      <option value="64">Series</option>
      <option value="96">Parallel</option>
    </select>
    Remote Control:
    <input id="patchControl" type="checkbox" onChange="sendCc(26, this.checked ? 127 : 0)"/>
  </p>

  <!-- <p>Remote Control: -->
  <!--   <input id="patchControl" type="checkbox" onChange="sendCc(26, this.checked ? 127 : 0)"/> -->
  <!-- </p> -->

  <p>Parameters:</p>
  <div>A
    <input id="parameterA" type="range" min="0" max="127" step="1" onChange="sendCc(20, this.value)"/>
    <span id="nameParameterA">Knob A</span>
  </div>
  <p>B
    <input id="parameterB" type="range" min="0" max="127" step="1" onChange="sendCc(21, this.value)"/>
    <span id="nameParameterB">Knob B</span>
  </p>
  <p>C
    <input id="parameterC" type="range" min="0" max="127" step="1" onChange="sendCc(22, this.value)"/>
    <span id="nameParameterC">Knob C</span>
  </p>
  <p>D 
    <input id="parameterD" type="range" min="0" max="127" step="1" onChange="sendCc(23, this.value)"/>
    <span id="nameParameterD">Knob D</span>
  </p>
  <p>E 
    <input id="parameterE" type="range" min="0" max="127" step="1" onChange="sendCc(24, this.value)"/>
    <span id="nameParameterE">Expression Pedal</span>
  </p>

  <p><button id="pushbutton" onClick="pressPushbutton()">Pushbutton</button></p>

  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 0)">Load Device Info</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 1)">Load Patch Names</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 2)">Load Parameter Names</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 3)">Load Firmware Version</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 4)">Load Device ID</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 5)">Self Test</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, OpenWareMidiControl.PATCH_BUTTON)">Load Pushbutton</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, OpenWareMidiControl.LED)">Load LED</button></p> -->
  <!-- <p><button onClick="sendCc(OpenWareMidiControl.REQUEST_SETTINGS, 127)">Load settings</button></p> -->

  <!-- <p><a href="chrome://flags/#enable-web-midi">Enable Chrome Web MIDI</a></p> -->
  <!-- <p><a href="http://jazz-soft.net/download/Jazz-Plugin/">Download Jazz Plugin</a></p> -->
</body>
</html>
